<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Approve Users - Admin Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ===== MOBILE-FIRST RESPONSIVE CSS FOR ADMIN PANEL ===== */
:root {
  --primary: #4361ee;
  --success: #2ecc71;
  --danger: #e74c3c;
  --warning: #f39c12;
  --info: #3498db;
  --dark: #2c3e50;
  --light: #ecf0f1;
  --gray: #95a5a6;
}

/* General Styles */
* {
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 0;
  background-color: #f5f7fa;
  color: #333;
  line-height: 1.6;
  font-size: 14px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 15px;
  width: 100%;
}

/* Header */
header {
  background-color: var(--dark);
  color: white;
  padding: 15px 0;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 15px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: flex-end;
}

header h2 {
  margin: 0;
  font-size: 1.3rem;
}

/* User Profile */
.user-profile {
  position: relative;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
  border: 2px solid transparent;
  transition: border-color 0.3s ease;
}

.user-avatar:hover {
  border-color: var(--primary);
}

.profile-dropdown {
  position: absolute;
  right: 0;
  top: 42px;
  background-color: white;
  min-width: 160px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 6px;
  overflow: hidden;
  z-index: 1000;
  display: none;
}

.profile-dropdown.active {
  display: block;
}

.profile-dropdown a {
  display: block;
  padding: 10px 14px;
  color: #333;
  text-decoration: none;
  transition: background-color 0.3s ease;
  border-bottom: 1px solid #eee;
  font-size: 0.85rem;
}

.profile-dropdown a:last-child {
  border-bottom: none;
}

.profile-dropdown a:hover {
  background-color: var(--primary);
  color: white;
}

.profile-dropdown a i {
  margin-right: 6px;
  width: 14px;
  text-align: center;
}

/* Admin Stats Section */
.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.stat-card {
  background-color: white;
  padding: 15px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  text-align: center;
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-3px);
}

.stat-card h3 {
  margin-top: 0;
  color: var(--gray);
  font-size: 0.9rem;
  margin-bottom: 8px;
}

.stat-card p {
  margin: 0;
  font-size: 1.5rem;
  font-weight: bold;
}

.stat-card.total p { color: var(--primary); }
.stat-card.active p { color: var(--success); }
.stat-card.pending p { color: var(--warning); }
.stat-card.approved p { color: var(--info); }
.stat-card.banned p { color: var(--danger); }
.stat-card.declined p { color: var(--gray); }

/* Search & Filter Section */
.controls {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
  background-color: white;
  padding: 15px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

.search-container {
  flex: 1;
  min-width: 100%;
}

.filter-container {
  min-width: 100%;
}

#searchBar {
  width: 100%;
  padding: 10px 12px;
  font-size: 0.9rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  background-color: #f8f9fa;
}

#userFilter {
  width: 100%;
  padding: 10px;
  font-size: 0.9rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  background-color: #f8f9fa;
}

/* Bulk Actions */
.bulk-actions {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.bulk-actions button {
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s ease;
  font-size: 0.85rem;
  flex: 1;
  min-width: 120px;
}

.bulk-actions button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.bulk-approve {
  background-color: var(--success);
  color: white;
}

.bulk-decline {
  background-color: var(--danger);
  color: white;
}

.bulk-ban {
  background-color: var(--warning);
  color: white;
}

/* Users Container */
#usersContainer {
  display: grid;
  grid-template-columns: 1fr;
  gap: 15px;
  margin-top: 15px;
}

#usersContainer.loading {
  display: block;
  text-align: center;
  font-size: 1rem;
  color: #555;
}

/* Individual User Card */
.user-card {
  background-color: #fff;
  border-left: 5px solid var(--primary);
  padding: 15px;
  border-radius: 6px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
  transition: all 0.3s ease;
  position: relative;
}

.user-card:hover {
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.user-card.pending { border-left-color: var(--warning); }
.user-card.approved { border-left-color: var(--success); }
.user-card.banned { border-left-color: var(--danger); }
.user-card.declined { border-left-color: var(--gray); }

.user-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  gap: 10px;
}

.user-header > div:first-child {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  flex: 1;
}

.user-name {
  font-weight: bold;
  font-size: 1rem;
  margin: 0 0 4px 0;
  line-height: 1.2;
}

.user-status {
  font-size: 0.75rem;
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: 500;
  white-space: nowrap;
}

.status-pending { background-color: #fff3cd; color: #856404; }
.status-approved { background-color: #d4edda; color: #155724; }
.status-banned { background-color: #f8d7da; color: #721c24; }
.status-declined { background-color: #e2e3e5; color: #383d41; }

.role-badge {
  font-size: 0.65rem;
  padding: 2px 6px;
  border-radius: 4px;
  margin-left: 5px;
  background-color: var(--primary);
  color: white;
}

.user-details {
  margin-bottom: 12px;
}

.user-detail {
  display: flex;
  margin-bottom: 4px;
  font-size: 0.85rem;
}

.user-detail strong {
  min-width: 70px;
  display: inline-block;
  color: #666;
}

.user-actions {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.user-actions button {
  padding: 6px 10px;
  font-size: 0.8rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 4px;
  flex: 1;
  min-width: 80px;
  justify-content: center;
}

.user-actions .approve-btn {
  background-color: var(--success);
  color: white;
}

.user-actions .decline-btn {
  background-color: var(--danger);
  color: white;
}

.user-actions .ban-btn {
  background-color: var(--warning);
  color: white;
}

.user-actions .delete-btn {
  background-color: #6c757d;
  color: white;
}

.user-actions button:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.user-actions button:active {
  transform: translateY(0);
}

.user-checkbox {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 18px;
  height: 18px;
}

/* Loading State */
.loading-spinner {
  display: inline-block;
  width: 18px;
  height: 18px;
  border: 2px solid rgba(0,0,0,.1);
  border-radius: 50%;
  border-top-color: var(--primary);
  animation: spin 1s ease-in-out infinite;
  margin-right: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 15px;
}

.modal-content {
  background-color: white;
  padding: 20px;
  border-radius: 6px;
  max-width: 500px;
  width: 100%;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.modal-title {
  margin-top: 0;
  color: var(--dark);
  font-size: 1.2rem;
}

.modal-body {
  margin: 15px 0;
  font-size: 0.95rem;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.modal-actions button {
  padding: 8px 14px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
}

.modal-cancel {
  background-color: #6c757d;
  color: white;
}

.modal-confirm {
  background-color: var(--danger);
  color: white;
}

/* ===== MEDIA QUERIES ===== */

/* Small phones (up to 360px) */
@media (max-width: 360px) {
  body {
    padding: 10px;
    font-size: 13px;
  }
  
  .container {
    padding: 10px;
  }
  
  .header-content {
    padding: 0 10px;
  }
  
  header {
    padding: 12px 0;
  }
  
  header h2 {
    font-size: 1.2rem;
  }
  
  .stats-container {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
  }
  
  .stat-card {
    padding: 12px;
  }
  
  .stat-card h3 {
    font-size: 0.85rem;
  }
  
  .stat-card p {
    font-size: 1.3rem;
  }
  
  .controls {
    padding: 12px;
  }
  
  .user-card {
    padding: 12px;
  }
  
  .user-actions button {
    font-size: 0.75rem;
    padding: 5px 8px;
    min-width: 70px;
  }
  
  .bulk-actions button {
    min-width: 100px;
    font-size: 0.8rem;
  }
}

/* Medium phones (361px to 480px) */
@media (min-width: 361px) and (max-width: 480px) {
  .header-content {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }
  
  .stats-container {
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  }
  
  .bulk-actions {
    justify-content: center;
  }
  
  .bulk-actions button {
    flex: none;
  }
}

/* Large phones (481px to 767px) */
@media (min-width: 481px) {
  .header-content {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }
  
  .controls {
    flex-direction: row;
  }
  
  .search-container {
    min-width: auto;
  }
  
  .filter-container {
    min-width: 180px;
  }
  
  #usersContainer {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  }
  
  .bulk-actions button {
    flex: none;
  }
}

/* Tablets and larger (768px+) */
@media (min-width: 768px) {
  body {
    padding: 20px;
    font-size: 14px;
  }
  
  .container {
    padding: 20px;
  }
  
  .header-content {
    padding: 0 20px;
  }
  
  header {
    padding: 20px 0;
    margin-bottom: 30px;
  }
  
  header h2 {
    font-size: 1.5rem;
  }
  
  .stats-container {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
  }
  
  .stat-card {
    padding: 20px;
  }
  
  .stat-card h3 {
    font-size: 1rem;
  }
  
  .stat-card p {
    font-size: 1.8rem;
  }
  
  .controls {
    padding: 20px;
    margin-bottom: 25px;
  }
  
  #usersContainer {
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .user-card {
    padding: 20px;
  }
  
  .user-actions button {
    font-size: 0.85rem;
    padding: 6px 12px;
    min-width: 80px;
  }
  
  .bulk-actions button {
    padding: 8px 15px;
    font-size: 0.9rem;
  }
}

/* Desktop (900px+) */
@media (min-width: 900px) {
  .stats-container {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
}

/* ===== UTILITY CLASSES ===== */
.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }
.text-muted { color: #6c757d; }
.mt-1 { margin-top: 8px; }
.mt-2 { margin-top: 16px; }
.mt-3 { margin-top: 1rem; }
.mb-1 { margin-bottom: 8px; }
.mb-2 { margin-bottom: 16px; }
.mb-3 { margin-bottom: 1rem; }
.hidden { display: none; }
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-1 { gap: 8px; }
.gap-2 { gap: 16px; }
.w-full { width: 100%; }

/* ===== ACCESSIBILITY IMPROVEMENTS ===== */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  
  .stat-card:hover {
    transform: none;
  }
  
  .user-card:hover {
    transform: none;
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  :root {
    --primary: #0044cc;
    --success: #006600;
    --warn: #663300;
    --danger: #990000;
  }
  
  .status-badge, .role-badge {
    border: 1px solid currentColor;
  }
}

/* Focus styles for accessibility */
button:focus,
input:focus,
select:focus {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

/* Print styles */
@media print {
  .bulk-actions,
  .profile-dropdown,
  .user-checkbox {
    display: none !important;
  }
  
  .user-card {
    break-inside: avoid;
    box-shadow: none;
    border: 1px solid #ddd;
  }
}
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="header-left">
        <h2><i class="fas fa-user-shield"></i> Admin Panel - User Management</h2>
      </div>
      <div class="header-right">
        <div class="user-profile">
          <img src="../images/no profile pic.jpg" alt="Admin Profile" class="user-avatar" id="adminAvatar">
          <div class="profile-dropdown" id="profileDropdown">
            <a href="../home/home.html"><i class="fas fa-home"></i>Home</a>
            <a href="../home/profile/profile.html"><i class="fas fa-user"></i> Profile</a>
            <a href="../home/shopping/orders/orders.html"><i class="fas fa-box"></i> Orders</a>
            <a href="../home/delivery/delivery.html"><i class="fas fa-shipping-fast"></i>Carriers</a>
            <a href="../home/seller/testsell.html"><i class="fas fa-plus-circle"></i>Dashboard</a>
            <a href="../home/market/market.html"><i class="fas fa-store"></i>Marketplace</a>
            <a href="../home/map/map.html"><i class="fas fa-map-marker-alt"></i>Map</a>
            
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <section class="stats-container">
      <div class="stat-card total">
        <h3><i class="fas fa-users"></i> Total Users</h3>
        <p id="totalUsers">0</p>
      </div>
      <div class="stat-card active">
        <h3><i class="fas fa-user-check"></i> Active Today</h3>
        <p id="activeToday">0</p>
      </div>
      <div class="stat-card pending">
        <h3><i class="fas fa-clock"></i> Pending</h3>
        <p id="pendingCount">0</p>
      </div>
      <div class="stat-card approved">
        <h3><i class="fas fa-check-circle"></i> Approved</h3>
        <p id="approvedCount">0</p>
      </div>
      <div class="stat-card banned">
        <h3><i class="fas fa-ban"></i> Banned</h3>
        <p id="bannedCount">0</p>
      </div>
      <div class="stat-card declined">
        <h3><i class="fas fa-times-circle"></i> Declined</h3>
        <p id="declinedCount">0</p>
      </div>
    </section>

    <section class="controls">
      <div class="search-container">
        <input type="text" id="searchBar" placeholder="Search users by name, email, or index...">
      </div>
      <div class="filter-container">
        <select id="userFilter">
          <option value="all">All Users</option>
          <option value="pending">Pending Approval</option>
          <option value="approved">Approved Users</option>
          <option value="banned">Banned Users</option>
          <option value="declined">Declined Users</option>
        </select>
      </div>
    </section>

    <div class="bulk-actions">
      <button class="bulk-approve" id="bulkApproveBtn" disabled><i class="fas fa-check"></i> Approve Selected</button>
      <button class="bulk-decline" id="bulkDeclineBtn" disabled><i class="fas fa-times"></i> Decline Selected</button>
      <button class="bulk-ban" id="bulkBanBtn" disabled><i class="fas fa-ban"></i> Ban Selected</button>
    </div>

    <main id="usersContainer" class="loading">
      <p><span class="loading-spinner"></span> Loading users...</p>
    </main>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmationModal">
    <div class="modal-content">
      <h3 class="modal-title" id="modalTitle">Confirm Action</h3>
      <div class="modal-body" id="modalBody">
        Are you sure you want to perform this action?
      </div>
      <div class="modal-actions">
        <button class="modal-cancel" id="modalCancelBtn">Cancel</button>
        <button class="modal-confirm" id="modalConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>

<script type="module">
  // Firebase imports - UPDATED to v10.11.1
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
  import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
  import { getAuth, deleteUser, EmailAuthProvider, reauthenticateWithCredential, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBzPa671GH71UvTcZ3dECFPrW4xe1vS9ds",
    authDomain: "marketplace-e0bff.firebaseapp.com",
    projectId: "marketplace-e0bff",
    storageBucket: "marketplace-e0bff.appspot.com",
    messagingSenderId: "892936444768",
    appId: "1:892936444768:web:f595b3a3e5d697988e1c05",
    databaseURL: "https://marketplace-e0bff-default-rtdb.europe-west1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const usersRef = ref(db, "users");

  // State
  let usersData = {};
  let selectedUsers = new Set();
  let currentModalAction = null;
  let currentModalUserId = null;
  let currentAdminUser = null;

  // DOM
  const usersContainer = document.getElementById('usersContainer');
  const searchBar = document.getElementById('searchBar');
  const userFilter = document.getElementById('userFilter');
  const confirmationModal = document.getElementById('confirmationModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalCancelBtn = document.getElementById('modalCancelBtn');
  const modalConfirmBtn = document.getElementById('modalConfirmBtn');
  const bulkApproveBtn = document.getElementById('bulkApproveBtn');
  const bulkDeclineBtn = document.getElementById('bulkDeclineBtn');
  const bulkBanBtn = document.getElementById('bulkBanBtn');
  const adminAvatar = document.getElementById('adminAvatar');
  const profileDropdown = document.getElementById('profileDropdown');
  const logoutBtn = document.getElementById('logoutBtn');

  // Role hierarchy
  const hierarchy = { 'user': 1, 'moderator': 2, 'admin': 3, 'superadmin': 4 };

  // Improved authentication check
  function checkAdminAuth() {
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // User is signed in, check if they're an admin
        currentAdminUser = user;
        const userRef = ref(db, `users/${user.uid}`);
        onValue(userRef, (snapshot) => {
        const userData = snapshot.val();
        if (userData && (userData.role === 'admin' || userData.role === 'superadmin')) {
          // User is admin, proceed with loading
          updateAdminProfile(userData); // ADD THIS LINE
          loadUsers();
        } else {
          // User is not admin, redirect
          alert("Access denied. Admin privileges required.");
          window.location.href = '../index.html';
        }
      });
      } 
      else {
        // No user signed in, show login prompt
        showLoginPrompt();
      }
    });
  }

  function showLoginPrompt() {
    const email = prompt("Admin Email:");
    if (!email) {
      window.location.href = '../index.html';
      return;
    }
    
    const password = prompt("Admin Password:");
    if (!password) {
      window.location.href = '../index.html';
      return;
    }

    signInWithEmailAndPassword(auth, email, password)
      .then((userCredential) => {
        currentAdminUser = userCredential.user;
        // Verify admin role after sign in
        const userRef = ref(db, `users/${userCredential.user.uid}`);
        onValue(userRef, (snapshot) => {
          const userData = snapshot.val();
          if (userData && (userData.role === 'admin' || userData.role === 'superadmin')) {
            // Admin verified, proceed
            updateAdminProfile(userData); // ADD THIS LINE
            loadUsers();
          } else {
            alert("Access denied. Admin privileges required.");
            signOut(auth);
            window.location.href = '../index.html';
          }
        });
      })
      .catch((error) => {
        alert("Authentication failed: " + error.message);
        window.location.href = '../index.html';
      });
  }

    // Add this function after the showLoginPrompt function
  function updateAdminProfile(userData) {
      if (userData && userData.profilePictureUrl) {
          adminAvatar.src = userData.profilePictureUrl;
      } else {
          adminAvatar.src = '../images/no profile pic.jpg';
      }
  }

  function loadUsers() {
    usersContainer.innerHTML = '<p><span class="loading-spinner"></span> Loading users...</p>';
    
    onValue(usersRef, (snapshot) => {
      usersData = snapshot.exists() ? snapshot.val() : {};
      filterAndRenderUsers();
    });
  }

  function formatDate(timestamp) { 
    if (!timestamp) return 'N/A'; 
    const d = new Date(timestamp); 
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString(); 
  }

  function updateStats(users) {
    let total=0, approved=0, pending=0, banned=0, declined=0;
    for (const id in users) {
      const u = users[id]; total++;
      if (u.banned) banned++;
      else if (u.declined) declined++;
      else if (u.approved) approved++;
      else pending++;
    }
    const active = approved + pending;
    document.getElementById('totalUsers').textContent = total;
    document.getElementById('activeToday').textContent = active;
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('approvedCount').textContent = approved;
    document.getElementById('bannedCount').textContent = banned;
    document.getElementById('declinedCount').textContent = declined;
  }

  function renderUsers(users) {
    usersContainer.innerHTML = '';
    
    // Get current admin's role from usersData
    const currentAdminRole = currentAdminUser ? usersData[currentAdminUser.uid]?.role : null;

    if (Object.keys(users).length === 0) { 
      usersContainer.innerHTML = '<p class="text-center text-muted">No users found.</p>'; 
      return; 
    }

    for (const id in users) {
      const u = users[id];
      let statusText='', statusClass='', cardStatusClass='';
      if (u.banned) { statusText='Banned'; statusClass='status-banned'; cardStatusClass='banned'; }
      else if (u.declined) { statusText='Declined'; statusClass='status-declined'; cardStatusClass='declined'; }
      else if (u.approved) { statusText='Approved'; statusClass='status-approved'; cardStatusClass='approved'; }
      else { statusText='Pending'; statusClass='status-pending'; cardStatusClass='pending'; }

      // FIXED: Get roles properly and check hierarchy
      const targetUserRole = u.role || 'user';
      const canAct = currentAdminRole && hierarchy[currentAdminRole] > hierarchy[targetUserRole];
      
      const roleBadge = `<span class="role-badge role-${u.role || 'user'}">${(u.role || 'user').charAt(0).toUpperCase() + (u.role || 'user').slice(1)}</span>`;

      const card = document.createElement('div');
      card.className = `user-card ${cardStatusClass}`;
      card.innerHTML = `
  <input type="checkbox" class="user-checkbox" data-userid="${id}" ${selectedUsers.has(id)?'checked':''} ${!canAct?'disabled':''}>
  <div class="user-header">
    <div style="display: flex; align-items: center; gap: 10px;">
      <img src="${u.profilePictureUrl || '../images/no profile pic.jpg'}" alt="${u.name || 'User'}" 
           style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #eee;"
           onerror="this.src='../images/no profile pic.jpg'">
      <div>
        <h3 class="user-name">${u.name || 'No Name'} ${roleBadge}</h3>
        <div style="font-size: 0.8rem; color: #666;">${u.email || 'N/A'}</div>
      </div>
    </div>
    <span class="user-status ${statusClass}">${statusText}</span>
  </div>
  <div class="user-details">
    <div class="user-detail"><strong>Index:</strong> ${u.index || 'N/A'}</div>
    <div class="user-detail"><strong>Program:</strong> ${u.program || 'N/A'}</div>
    <div class="user-detail"><strong>Phone:</strong> ${u.phone || 'N/A'}</div>
    ${u.message?`<div class="user-detail"><strong>Message:</strong> ${u.message}</div>`:``}
    ${u.registrationDate?`<div class="user-detail"><strong>Registered:</strong> ${formatDate(u.registrationDate)}</div>`:``}
  </div>
  <div class="user-actions">
    ${canAct && !u.approved && !u.banned?`<button class="approve-btn" onclick="approveUser('${id}')"><i class="fas fa-check"></i> Approve</button>`:``}
    ${canAct && u.approved && !u.banned?`<button class="decline-btn" onclick="declineUser('${id}')"><i class="fas fa-times"></i> Decline</button>`:``}
    ${canAct && !u.banned?`<button class="ban-btn" onclick="banUser('${id}')"><i class="fas fa-ban"></i> Ban</button>`: (canAct?`<button class="approve-btn" onclick="unbanUser('${id}')"><i class="fas fa-unlock"></i> Unban</button>`:``)}
    ${canAct?`<button class="delete-btn" onclick="confirmDeleteUser('${id}','${u.email||''}')"><i class="fas fa-trash"></i> Delete</button>`:``}
  </div>
`;
      usersContainer.appendChild(card);
    }

    document.querySelectorAll('.user-checkbox').forEach(cb=>{
      cb.addEventListener('change', function(){
        const userId = this.dataset.userid;
        this.checked?selectedUsers.add(userId):selectedUsers.delete(userId);
        updateBulkActionsState();
      });
    });
  }

  function filterAndRenderUsers() {
    const q=searchBar.value.toLowerCase(), status=userFilter.value, filtered={};
    for(const id in usersData){
      const u=usersData[id];
      const match = (u.name?.toLowerCase().includes(q) || u.email?.toLowerCase().includes(q) || u.index?.toLowerCase().includes(q));
      let statusMatch=false;
      if(status==='all') statusMatch=true;
      else if(status==='approved' && u.approved) statusMatch=true;
      else if(status==='pending' && !u.approved && !u.banned && !u.declined) statusMatch=true;
      else if(status==='banned' && u.banned) statusMatch=true;
      else if(status==='declined' && u.declined) statusMatch=true;
      if(match && statusMatch) filtered[id]=u;
    }
    renderUsers(filtered);
    updateStats(filtered);
  }

  function showModal(title,msg,action,userId=null){currentModalAction=action;currentModalUserId=userId;modalTitle.textContent=title;modalBody.textContent=msg;confirmationModal.style.display='flex';}
  function hideModal(){confirmationModal.style.display='none';currentModalAction=null;currentModalUserId=null;}

  window.approveUser=id=>showModal('Approve User',`Approve ${usersData[id]?.name||'this user'}?`,'approve',id);
  window.declineUser=id=>showModal('Decline User',`Decline ${usersData[id]?.name||'this user'}?`,'decline',id);
  window.banUser=id=>showModal('Ban User',`Ban ${usersData[id]?.name||'this user'}?`,'ban',id);
  window.unbanUser=id=>showModal('Unban User',`Unban ${usersData[id]?.name||'this user'}?`,'unban',id);
  window.confirmDeleteUser=(id,email)=>showModal('Delete User',`Delete ${usersData[id]?.name||'this user'}?`,'delete',id);

  function performUserAction(action,id){
    let updates={},msg='';
    switch(action){
      case'approve':updates={approved:true,declined:false,banned:false};msg='User approved!';break;
      case'decline':updates={approved:false,declined:true,banned:false};msg='User declined!';break;
      case'ban':updates={approved:false,declined:false,banned:true};msg='User banned!';break;
      case'unban':updates={banned:false};msg='User unbanned!';break;
      case'delete':return deleteUserFromSystem(id);default:return;
    }
    update(ref(db,`users/${id}`),updates).then(()=>{alert(msg);selectedUsers.delete(id);updateBulkActionsState();}).catch(err=>alert('Error: '+err.message));
  }

  function deleteUserFromSystem(id){
    const user=usersData[id];if(!user)return;
    const currentUser=auth.currentUser;
    if(currentUser && currentUser.email===user.email){
      const pw=prompt("Enter password to confirm deletion:");if(!pw)return;
      const cred=EmailAuthProvider.credential(currentUser.email,pw);
      reauthenticateWithCredential(currentUser,cred).then(()=>deleteUser(currentUser)).then(()=>remove(ref(db,`users/${id}`))).then(()=>{alert('âœ… Your account deleted');window.location.href='/login.html';}).catch(err=>alert('âŒ Error deleting account: '+err.message));
    }else{
      remove(ref(db,`users/${id}`)).then(()=>{alert('ðŸ—‘ï¸ User deleted');selectedUsers.delete(id);updateBulkActionsState();}).catch(err=>alert('âŒ Error deleting user: '+err.message));
    }
  }

  function updateBulkActionsState(){
    bulkApproveBtn.disabled=selectedUsers.size===0;
    bulkDeclineBtn.disabled=selectedUsers.size===0;
    bulkBanBtn.disabled=selectedUsers.size===0;
  }

  function performBulkAction(action){
    if(selectedUsers.size===0)return;
    let msg='',txt='';
    switch(action){
      case'approve':msg=`Approve ${selectedUsers.size} users?`;txt='Approve';break;
      case'decline':msg=`Decline ${selectedUsers.size} users?`;txt='Decline';break;
      case'ban':msg=`Ban ${selectedUsers.size} users?`;txt='Ban';break;
      default:return;
    }
    showModal(`${txt} Users`,msg,`bulk_${action}`);
  }

  // FIXED: Bulk user action with proper role checking
  function performBulkUserAction(action){
    const currentAdminRole = currentAdminUser ? usersData[currentAdminUser.uid]?.role : null;
    
    const validIds=Array.from(selectedUsers).filter(uid=>{
      const targetUser = usersData[uid];
      const targetUserRole = targetUser?.role || 'user';
      return currentAdminRole && hierarchy[currentAdminRole] > hierarchy[targetUserRole];
    });

    if(validIds.length===0) return alert('No users can be acted upon due to role restrictions.');
    
    let updates={},msg='';
    switch(action){
      case'bulk_approve':updates={approved:true,declined:false,banned:false};msg='Selected users approved!';break;
      case'bulk_decline':updates={approved:false,declined:true,banned:false};msg='Selected users declined!';break;
      case'bulk_ban':updates={approved:false,declined:false,banned:true};msg='Selected users banned!';break;
      default:return;
    }
    
    Promise.all(validIds.map(uid=>update(ref(db,`users/${uid}`),updates)))
      .then(()=>{
        alert(msg);
        selectedUsers.clear();
        updateBulkActionsState();
        document.querySelectorAll('.user-checkbox').forEach(cb=>cb.checked=false);
      })
      .catch(err=>alert('Error: '+err.message));
  }

  function init(){
    // Profile dropdown
    adminAvatar.addEventListener('click', () => {
      profileDropdown.classList.toggle('active');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.user-profile')) {
        profileDropdown.classList.remove('active');
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        alert('Logged out successfully');
        window.location.href = '../index.html';
      } catch (error) {
        alert('Error logging out: ' + error.message);
      }
    });

    checkAdminAuth();
    onValue(usersRef,snap=>{usersData=snap.exists()?snap.val():{};filterAndRenderUsers();});
    searchBar.addEventListener('input',filterAndRenderUsers);
    userFilter.addEventListener('change',filterAndRenderUsers);
    modalCancelBtn.addEventListener('click',hideModal);
    modalConfirmBtn.addEventListener('click',()=>{
      if(currentModalAction && currentModalAction.startsWith('bulk_')) performBulkUserAction(currentModalAction); 
      else if(currentModalAction && currentModalUserId) performUserAction(currentModalAction,currentModalUserId); 
      hideModal();
    });
    bulkApproveBtn.addEventListener('click',()=>performBulkAction('approve'));
    bulkDeclineBtn.addEventListener('click',()=>performBulkAction('decline'));
    bulkBanBtn.addEventListener('click',()=>performBulkAction('ban'));
    confirmationModal.addEventListener('click',e=>{if(e.target===confirmationModal) hideModal();});
  }

  init();
</script>

</body>
</html>